<!-- File: Views/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | MedBridge</title>
  <link rel="stylesheet" href="/public/css/style.css">

  <style>
    .item-card {
      border: 1px solid #9fdaf8;
      padding: 15px;
      margin: 10px;
      border-radius: 8px;
      background: #6652f8;
      color: white;
    }
    .item-card img {
      width: 120px;
      height: auto;
    }
    button {
      margin-right: 5px;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      background-color: #ffffff;
      color: #000;
      cursor: pointer;
    }
    button:hover {
      background-color: #ddd;
    }
    .actions {
      margin-top: 10px;
    }
    .payment-box {
      background: #ffefc2;
      border: 1px solid #e0b200;
      padding: 10px;
      margin: 10px;
      border-radius: 6px;
      color: #000;
    }
  </style>
</head>
<body>
  <header>
    <h1>üì¶ Available Medical Items</h1>
    <p><a href="/logout">Logout</a></p>
    <button onclick="window.location.href='/post.html'">‚ûï Post New Item</button>
  </header>

  <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);">
    <a href="/"><button>üè† Home</button></a>
  </div>

  <main>
    <div id="payment-alert"></div>
    <div id="item-list">
      <p>Loading items...</p>
    </div>
  </main>

  <script>
    const loggedInUserId = 1; // üîÅ Replace with actual logged-in user's ID

    window.onload = async function () {
      await checkPaymentStatus();
      await loadItems();
    };

    async function checkPaymentStatus() {
      try {
        const res = await fetch(`/api/requests?user_id=${loggedInUserId}`);
        const requests = await res.json();

        const approvedRequest = requests.find(r => r.status === 'approved');
        if (approvedRequest) {
          document.getElementById('payment-alert').innerHTML = `
            <div class="payment-box">
              <h3>üí∞ Payment Required</h3>
              <p>Your request for <strong>${approvedRequest.item_title}</strong> has been approved.</p>
              <p>Amount: <strong>‡ß≥${approvedRequest.rental_amount}</strong></p>
              <p>Send payment to: <strong>Bkash 01XXXXXXXXX</strong></p>
            </div>
          `;
        }
      } catch (err) {
        console.error('‚ùå Failed to check payment status:', err);
      }
    }

    async function loadItems() {
      const container = document.getElementById('item-list');

      try {
        const res = await fetch('/api/items');
        const items = await res.json();

        if (!Array.isArray(items)) {
          throw new Error('Invalid data from backend');
        }

        container.innerHTML = ''; 
        items.forEach(item => {
          const card = document.createElement('div');
          card.className = 'item-card';

          card.innerHTML = `
            <h3>${item.title}</h3>
            <p>${item.description}</p>
            <p><strong>Rental:</strong> ${item.is_rental ? 'Yes (‡ß≥' + (item.rental_price || '0') + ')' : 'No'}</p>
            <div class="actions">
              <button onclick="requestItem(${item.id})">Request</button>
              ${item.user_id === loggedInUserId ? `
                <button onclick="editItem(${item.id})">Edit</button>
                <button onclick="deleteItem(${item.id})">Delete</button>
              ` : ''}
            </div>
          `;

          container.appendChild(card);
        });

      } catch (err) {
        container.innerHTML = '<p>‚ö†Ô∏è Error loading items. Check server or DB.</p>';
        console.error('‚ùå Failed to load items:', err);
      }
    }

    function requestItem(itemId) {
      window.location.href = `/request.html?item=${itemId}`;
    }

    function editItem(itemId) {
      window.location.href = `/edit.html?id=${itemId}`;
    }

    async function deleteItem(itemId) {
      if (!confirm('Are you sure you want to delete this item?')) return;

      try {
        const res = await fetch(`/api/items/${itemId}`, {
          method: 'DELETE'
        });

        const data = await res.json();
        alert(data.message || 'Deleted!');
        window.location.reload();
      } catch (err) {
        alert('Error deleting item');
      }
    }
  </script>
</body>
</html>
